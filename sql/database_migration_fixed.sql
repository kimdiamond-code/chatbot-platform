-- Fixed Database Migration for Shopify Integration\n-- This addresses the credentials column issue\n\n-- First, check if integrations table exists and what columns it has\nDO $$\nBEGIN\n    -- Drop and recreate the table to ensure correct schema\n    DROP TABLE IF EXISTS integrations CASCADE;\n    \n    -- Create integrations table with all required columns\n    CREATE TABLE integrations (\n        id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,\n        organization_id UUID DEFAULT '00000000-0000-0000-0000-000000000001',\n        integration_id VARCHAR(50) NOT NULL,\n        integration_name VARCHAR(255) NOT NULL,\n        status VARCHAR(50) DEFAULT 'disconnected',\n        config JSONB DEFAULT '{}',\n        credentials JSONB DEFAULT '{}', -- This column was missing in some setups\n        connected_at TIMESTAMP WITH TIME ZONE,\n        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n        CONSTRAINT integrations_unique_org_integration UNIQUE(organization_id, integration_id)\n    );\n    \n    -- Create indexes for performance\n    CREATE INDEX idx_integrations_org ON integrations(organization_id);\n    CREATE INDEX idx_integrations_status ON integrations(organization_id, status);\n    CREATE INDEX idx_integrations_lookup ON integrations(organization_id, integration_id);\n    \n    -- Enable Row Level Security\n    ALTER TABLE integrations ENABLE ROW LEVEL SECURITY;\n    \n    -- Create RLS policies\n    CREATE POLICY \"integrations_select_policy\" ON integrations FOR SELECT USING (true);\n    CREATE POLICY \"integrations_insert_policy\" ON integrations FOR INSERT WITH CHECK (true);\n    CREATE POLICY \"integrations_update_policy\" ON integrations FOR UPDATE USING (true);\n    CREATE POLICY \"integrations_delete_policy\" ON integrations FOR DELETE USING (true);\n    \n    RAISE NOTICE 'Integrations table created successfully with all required columns';\nEND $$;\n\n-- Insert default integrations\nINSERT INTO integrations (\n    organization_id,\n    integration_id,\n    integration_name,\n    status,\n    config,\n    credentials\n) VALUES \n(\n    '00000000-0000-0000-0000-000000000001',\n    'shopify',\n    'Shopify',\n    'disconnected',\n    '{\n        \"description\": \"Connect your Shopify store for product search, order tracking, and customer support\",\n        \"features\": [\"Product Search\", \"Order Tracking\", \"Customer Data\", \"Inventory Status\"],\n        \"category\": \"ecommerce\"\n    }',\n    '{}'\n),\n(\n    '00000000-0000-0000-0000-000000000001',\n    'kustomer',\n    'Kustomer CRM',\n    'disconnected',\n    '{\n        \"description\": \"Customer relationship management and support ticket integration\",\n        \"features\": [\"Customer Profiles\", \"Ticket Management\", \"Chat History\", \"Agent Assignment\"],\n        \"category\": \"crm\"\n    }',\n    '{}'\n),\n(\n    '00000000-0000-0000-0000-000000000001',\n    'klaviyo',\n    'Klaviyo',\n    'disconnected',\n    '{\n        \"description\": \"Email marketing automation and customer segmentation\",\n        \"features\": [\"Email Campaigns\", \"Customer Segmentation\", \"Analytics\", \"Automation\"],\n        \"category\": \"marketing\"\n    }',\n    '{}'\n)\nON CONFLICT (organization_id, integration_id) \nDO UPDATE SET \n    integration_name = EXCLUDED.integration_name,\n    config = EXCLUDED.config,\n    updated_at = NOW();\n\n-- Verify the table structure\nSELECT \n    column_name,\n    data_type,\n    is_nullable,\n    column_default\nFROM information_schema.columns \nWHERE table_name = 'integrations' \nORDER BY ordinal_position;\n\n-- Show the created integrations\nSELECT \n    integration_id,\n    integration_name,\n    status,\n    created_at\nFROM integrations \nORDER BY integration_id;